name: 自动打包并发布压缩包

# 触发条件：
# 1. 推送到main分支 + 指定文件发生更改
# 2. 创建新标签（如v1.0.0）
# 3. 手动触发
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    paths:
      - 'server_scripts/硬盘拯救者.js'  # 修复：Linux用/分隔符
      #- 'config/**'
      #- '*.jar'
      #- 'mods/*.sfm'
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - '.github/workflows/*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 打包文件为ZIP
        run: |
          # ========== 自定义配置（用数组存储文件，支持空格/特殊字符） ==========
          # 要打包的文件/目录（Linux路径分隔符/）
          declare -a FILES_TO_PACK=(
            "server_scripts/硬盘拯救者.js"
            # 可添加更多："config/" "mods/"
          )
          # ===================================

          # 创建临时目录
          mkdir -p temp_package
          
          # 复制文件（数组遍历，兼容空格/特殊字符）
          for file in "${FILES_TO_PACK[@]}"; do
            if [ -f "$file" ] || [ -d "$file" ]; then
              # 保留目录结构复制（避免文件平铺）
              cp -r --parents "$file" temp_package/
              echo "已加入打包：$file"
            else
              echo "警告：文件 $file 不存在，跳过"
            fi
          done
          
          # 打包（命名规则优化：标签触发用标签名，分支触发用时间）
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            PACKAGE_NAME="Disk-Savior-${{ github.ref_name }}.zip"
          else
            PACKAGE_NAME="Disk-Savior-$(date +%Y%m%d%H%M%S).zip"
          fi
          
          cd temp_package
          zip -r "../$PACKAGE_NAME" ./*
          cd ..
          
          echo "打包完成：$PACKAGE_NAME"
          ls -lh "$PACKAGE_NAME"
          
          # 输出变量供后续步骤使用
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      # 发布Release（仅当有打包文件时执行）
      - name: 创建Release并上传压缩包
        uses: softprops/action-gh-release@v2
        if: env.PACKAGE_NAME != ''  # 避免空包发布
        with:
          # 分支触发：标题带“预发布”，标签触发：用标签名
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
          name: ${{ github.ref_type == 'tag' ? github.ref_name : '自动打包预发布-' + env.PACKAGE_NAME }}
          body: "自动打包发布：\n- 触发方式：${{ github.ref_type == 'tag' ? '标签发布' : '分支推送/手动触发' }}\n- 打包文件：server_scripts/硬盘拯救者.js"
          files: ${{ env.PACKAGE_NAME }}
          prerelease: ${{ github.ref_type != 'tag' }}  # 标签触发为正式版，否则预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}